export const config = {
  runtime: "edge",
};

export default async function handler(request) {
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
  const headers = new Headers({
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
    "Content-Type": "application/json",
  });

  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º OPTIONS –∑–∞–ø—Ä–æ—Å
  if (request.method === "OPTIONS") {
    return new Response(null, { status: 200, headers });
  }

  try {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
    const body = request.method === "POST" ? await request.json() : null;

    // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–π webhook
    console.log("üì® Telegram webhook received (Edge):", {
      method: request.method,
      url: request.url,
      headers: Object.fromEntries(request.headers.entries()),
      body: body,
      timestamp: new Date().toISOString(),
    });

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (body && body.message) {
      const message = body.message;
      const chatId = message.chat?.id;
      const userId = message.from?.id;
      const username = message.from?.username;
      const text = message.text;

      console.log("üí¨ Message received:", {
        chat_id: chatId,
        user_id: userId,
        username: username,
        text: text,
        timestamp: new Date(message.date * 1000).toISOString(),
      });

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è
      if (chatId && text) {
        const botToken = process.env.BOT_TOKEN;
        let replyText = "";
        let keyboard = null;

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
        if (text.startsWith("/")) {
          const command = text.split(" ")[0].toLowerCase();

          switch (command) {
            case "/start":
              replyText = `üëã –ü—Ä–∏–≤–µ—Ç, ${username || "–¥—Ä—É–≥"}! \n\nü§ñ –Ø Instagram Scraper Bot –¥–ª—è —ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã.\n\nüìã –í–æ—Ç —á—Ç–æ —è —É–º–µ—é:\n\nüé§ /transcribe - –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ –ø–æ URL\nüìä /projects - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏\nüîç /competitors - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã\n#Ô∏è‚É£ /hashtags - –•—ç—à—Ç–µ–≥–∏\nüé¨ /scrape - –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞\nüëÄ /reels - –ü—Ä–æ—Å–º–æ—Ç—Ä Reels\nüìà /analytics - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞\nüîî /notifications - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\nüìã /collections - –ö–æ–ª–ª–µ–∫—Ü–∏–∏\nü§ñ /chatbot - –ß–∞—Ç-–±–æ—Ç\n‚ùì /help - –ü–æ–º–æ—â—å\n\n‚ú® –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é!`;
              keyboard = {
                keyboard: [
                  ["üé§ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ"],
                  ["üìä –ü—Ä–æ–µ–∫—Ç—ã", "üîç –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã"],
                  ["#Ô∏è‚É£ –•—ç—à—Ç–µ–≥–∏", "üé¨ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∞–ø–∏–Ω–≥"],
                  ["üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä Reels", "üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞"],
                  ["üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "üìã –ö–æ–ª–ª–µ–∫—Ü–∏–∏ Reels"],
                  ["ü§ñ –ß–∞—Ç-–±–æ—Ç"],
                  ["‚ÑπÔ∏è –ü–æ–º–æ—â—å"],
                ],
                resize_keyboard: true,
              };
              break;

            case "/transcribe":
              replyText = `üé¨ *–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è Instagram Reels* üé¨\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Instagram Reel, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å.\n\nüîÑ –Ø —Å–∫–∞—á–∞—é –≤–∏–¥–µ–æ\nüîä –ò–∑–≤–ª–µ–∫—É –∞—É–¥–∏–æ\nüìù –ü—Ä–µ–æ–±—Ä–∞–∑—É—é —Ä–µ—á—å –≤ —Ç–µ–∫—Å—Ç\n\n‚úÖ *–ü—Ä–∏–º–µ—Ä —Å—Å—ã–ª–∫–∏:*\nhttps://www.instagram.com/reel/ABC123/\n\n‚ö° **–ù–û–í–û–ï**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ Telegraf —Å—Ü–µ–Ω!`;
              break;

            case "/help":
              replyText = `‚ùì *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º*\n\nüé§ */transcribe* - –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ (–£–õ–£–ß–®–ï–ù–û!)\nüìä */projects* - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏\nüîç */competitors* - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏\n#Ô∏è‚É£ */hashtags* - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö—ç—à—Ç–µ–≥–∞–º–∏\nüé¨ */scrape* - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∞–ø–∏–Ω–≥\nüëÄ */reels* - –ü—Ä–æ—Å–º–æ—Ç—Ä Reels\nüìà */analytics* - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö\nüîî */notifications* - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\nüìã */collections* - –ö–æ–ª–ª–µ–∫—Ü–∏–∏ Reels\nü§ñ */chatbot* - –ß–∞—Ç-–±–æ—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –≤–∏–¥–µ–æ\n\nüí° *–°–æ–≤–µ—Ç:* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è —É–¥–æ–±–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏!\n\n‚ö° **–û–ë–ù–û–í–õ–ï–ù–ò–ï**: –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–≥–∏–∫—É –∏–∑ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö Telegraf —Å—Ü–µ–Ω!`;
              break;

            case "/projects":
              replyText = `üìä *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏*\n\n–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –¥–ª—è —Å–∫—Ä–∞–ø–∏–Ω–≥–∞ Instagram.\n\nüîß –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É */start* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.`;
              break;

            case "/competitors":
              replyText = `üîç *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏*\n\n–î–æ–±–∞–≤–ª—è–π—Ç–µ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.\n\nüîß –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É */start* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.`;
              break;

            case "/hashtags":
              replyText = `#Ô∏è‚É£ *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö—ç—à—Ç–µ–≥–∞–º–∏*\n\n–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ö—ç—à—Ç–µ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞.\n\nüîß –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É */start* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.`;
              break;

            case "/scrape":
              replyText = `üé¨ *–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞*\n\n–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å Instagram.\n\nüîß –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É */start* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.`;
              break;

            case "/reels":
              replyText = `üëÄ *–ü—Ä–æ—Å–º–æ—Ç—Ä Reels*\n\n–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ Reels –∏ –∏—Ö –¥–∞–Ω–Ω—ã–µ.\n\nüîß –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É */start* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.`;
              break;

            case "/analytics":
              replyText = `üìà *–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö*\n\n–ü–æ–ª—É—á–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.\n\nüîß –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É */start* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.`;
              break;

            case "/notifications":
              replyText = `üîî *–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π*\n\n–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.\n\nüîß –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É */start* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.`;
              break;

            case "/collections":
              replyText = `üìã *–ö–æ–ª–ª–µ–∫—Ü–∏–∏ Reels*\n\n–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ Reels.\n\nüîß –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É */start* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.`;
              break;

            case "/chatbot":
              replyText = `ü§ñ *–ß–∞—Ç-–±–æ—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –≤–∏–¥–µ–æ*\n\n–û–±—â–∞–π—Ç–µ—Å—å —Å –ò–ò –æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏ –≤–∞—à–∏—Ö –≤–∏–¥–µ–æ.\n\nüîß –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É */start* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.`;
              break;

            default:
              replyText = `‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: *${command}*\n\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\nüé§ /transcribe\nüìä /projects\nüîç /competitors\n#Ô∏è‚É£ /hashtags\nüé¨ /scrape\nüëÄ /reels\nüìà /analytics\nüîî /notifications\nüìã /collections\nü§ñ /chatbot\n‚ùì /help\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.`;
          }
        }
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
        else if (text === "üé§ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ") {
          replyText = `üé¨ *–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è Instagram Reels* üé¨\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Instagram Reel, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å.\n\nüîÑ –Ø —Å–∫–∞—á–∞—é –≤–∏–¥–µ–æ\nüîä –ò–∑–≤–ª–µ–∫—É –∞—É–¥–∏–æ\nüìù –ü—Ä–µ–æ–±—Ä–∞–∑—É—é —Ä–µ—á—å –≤ —Ç–µ–∫—Å—Ç\n\n‚úÖ *–ü—Ä–∏–º–µ—Ä —Å—Å—ã–ª–∫–∏:*\nhttps://www.instagram.com/reel/ABC123/\n\n‚ö° **–ù–û–í–û–ï**: –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ Telegraf —Å—Ü–µ–Ω!\nüí° –ü—Ä–æ–≥—Ä–µ—Å—Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –ø–æ—à–∞–≥–æ–≤–æ!`;
        } else if (text === "‚ÑπÔ∏è –ü–æ–º–æ—â—å") {
          replyText = `‚ùì *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É*\n\nü§ñ –Ø Instagram Scraper Bot –¥–ª—è —ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã.\n\nüé¨ *–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:* –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –≤–∏–¥–µ–æ –∏–∑ Instagram Reels\n\nüìã *–î—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:*\n‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏\n‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤\n‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ö—ç—à—Ç–µ–≥–æ–≤\n‚Ä¢ –°–±–æ—Ä –∏ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö\n‚Ä¢ –ò–ò-—á–∞—Ç —Å –≤–∏–¥–µ–æ\n\nüîß *–ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –±–æ—Ç–∞.*\n\nüí° –ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start`;
        }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç Instagram URL
        else if (
          text.includes("instagram.com/reel/") ||
          text.includes("instagram.com/p/")
        ) {
          replyText = `üîó *Instagram —Å—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞!*\n\nüìé URL: ${text}\n\nüîÑ *–ó–∞–ø—É—Å–∫–∞—é —É–ª—É—á—à–µ–Ω–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é...*\n\n‚ö° **–û–ë–ù–û–í–õ–ï–ù–ò–ï**: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –∏–∑ Telegraf —Å—Ü–µ–Ω!\n\n–û–∂–∏–¥–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç...`;

          // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
          try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω
            const currentUrl = new URL(request.url);
            const baseUrl = `${currentUrl.protocol}//${currentUrl.host}`;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é
            fetch(`${baseUrl}/api/transcribe-serverless`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                url: text,
                chatId: chatId,
              }),
            }).catch((error) => {
              console.error(
                "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏:",
                error
              );

              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
              fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  chat_id: chatId,
                  text: `‚ùå *–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏*\n\nüìù ${error.message}\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥—É—é —Å—Å—ã–ª–∫—É.`,
                  parse_mode: "Markdown",
                }),
              });
            });
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏:", error);
            replyText = `‚ùå *–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏*\n\nüìù ${error.message}\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥—É—é —Å—Å—ã–ª–∫—É.`;
          }
        }
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
        else if (
          [
            "üìä –ü—Ä–æ–µ–∫—Ç—ã",
            "üîç –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã",
            "#Ô∏è‚É£ –•—ç—à—Ç–µ–≥–∏",
            "üé¨ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∞–ø–∏–Ω–≥",
            "üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä Reels",
            "üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞",
            "üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
            "üìã –ö–æ–ª–ª–µ–∫—Ü–∏–∏ Reels",
            "ü§ñ –ß–∞—Ç-–±–æ—Ç",
          ].includes(text)
        ) {
          replyText = `üîß *–§—É–Ω–∫—Ü–∏—è "${text}"*\n\n–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–æ–π.\n\nüí° *–ß—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å:*\nüé§ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –≤–∏–¥–µ–æ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)\n‚ùì –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\nüìã –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ–Ω—é\n\nüöÄ *–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞:*\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–æ—Ç–∞ —Å –ø–æ–ª–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è.`;
        }
        // –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        else {
          replyText = `üí¨ *–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:* "${text}"\n\nüë§ *–û—Ç:* ${username || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}\nüÜî *ID:* ${userId}\nüí¨ *–ß–∞—Ç:* ${chatId}\n‚è∞ *–í—Ä–µ–º—è:* ${new Date().toLocaleString("ru-RU")}\n\nü§ñ *–Ø –ø–æ–Ω–∏–º–∞—é –∫–æ–º–∞–Ω–¥—ã –∏ Instagram —Å—Å—ã–ª–∫–∏.*\n\nüìã –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥ –∏–ª–∏ /start –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.`;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API
        const telegramPayload = {
          chat_id: chatId,
          text: replyText,
          parse_mode: "Markdown",
        };

        if (keyboard) {
          telegramPayload.reply_markup = keyboard;
        }

        const telegramResponse = await fetch(
          `https://api.telegram.org/bot${botToken}/sendMessage`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(telegramPayload),
          }
        );

        const telegramResult = await telegramResponse.json();

        console.log("üì§ Telegram API response:", {
          status: telegramResponse.status,
          result: telegramResult,
          timestamp: new Date().toISOString(),
        });

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
        return new Response(
          JSON.stringify({
            ok: true,
            message: "Message processed and reply sent",
            telegram_response: telegramResult,
            timestamp: new Date().toISOString(),
            method: request.method,
            bodyReceived: !!body,
            runtime: "edge",
            command_processed: text.startsWith("/")
              ? text.split(" ")[0]
              : "message",
          }),
          { status: 200, headers }
        );
      }
    }

    // –û—Ç–≤–µ—á–∞–µ–º Telegram —á—Ç–æ –≤—Å–µ –û–ö (–¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
    return new Response(
      JSON.stringify({
        ok: true,
        message: "Telegram webhook received successfully (Edge Function)",
        timestamp: new Date().toISOString(),
        method: request.method,
        bodyReceived: !!body,
        runtime: "edge",
      }),
      { status: 200, headers }
    );
  } catch (error) {
    console.error("‚ùå Webhook error:", error);

    return new Response(
      JSON.stringify({
        ok: false,
        error: error.message,
        timestamp: new Date().toISOString(),
        runtime: "edge",
      }),
      { status: 500, headers }
    );
  }
}
