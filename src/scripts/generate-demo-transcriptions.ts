/**
 * Скрипт для генерации демонстрационных транскрипций для рилсов
 *
 * Использование:
 * bun run src/scripts/generate-demo-transcriptions.ts <projectId> [minViews] [limit]
 *
 * Параметры:
 * - projectId: ID проекта
 * - minViews: (опционально) Минимальное количество просмотров (по умолчанию 50000)
 * - limit: (опционально) Максимальное количество рилсов для обработки (по умолчанию 100)
 */

import { NeonAdapter } from "../adapters/neon-adapter";
import dotenv from "dotenv";

// Загружаем переменные окружения из .env файла
dotenv.config();

// Получаем аргументы командной строки
const args = process.argv.slice(2);
if (args.length < 1) {
  console.error(
    "Использование: bun run src/scripts/generate-demo-transcriptions.ts <projectId> [minViews] [limit]"
  );
  process.exit(1);
}

const projectId = parseInt(args[0], 10);
const minViews = args[1] ? parseInt(args[1], 10) : 50000;
const limit = args[2] ? parseInt(args[2], 10) : 100;

if (isNaN(projectId) || isNaN(minViews) || isNaN(limit)) {
  console.error("Ошибка: projectId, minViews и limit должны быть числами");
  process.exit(1);
}

// Массив возможных транскрипций для косметологических рилсов
const possibleTranscriptions = [
  "Привет всем! Сегодня я хочу рассказать о процедуре HydraFacial. Это многоэтапная процедура очищения, эксфолиации и увлажнения кожи. Она помогает улучшить текстуру кожи, уменьшить морщины и улучшить общий тон лица. Процедура безболезненна и подходит для всех типов кожи. После нее вы заметите мгновенный результат - кожа станет более сияющей и увлажненной.",

  "Добрый день, дорогие подписчики! Сегодня мы поговорим о ботоксе. Ботокс - это инъекционная процедура, которая временно расслабляет мышцы, вызывающие морщины. Эффект длится около 3-4 месяцев. Процедура занимает всего несколько минут и практически безболезненна. Ботокс лучше всего работает для морщин в верхней части лица, таких как морщины на лбу и вокруг глаз.",

  "Всем привет! Сегодня я расскажу о филлерах на основе гиалуроновой кислоты. Эти инъекции помогают восстановить объем лица, разгладить морщины и улучшить контуры. Гиалуроновая кислота - это вещество, которое естественным образом присутствует в нашей коже. С возрастом его количество уменьшается, что приводит к потере объема и появлению морщин. Филлеры помогают восстановить этот объем и вернуть коже молодость.",

  "Здравствуйте! В этом видео я хочу поделиться информацией о химических пилингах. Это процедура, при которой на кожу наносится кислотный раствор, который удаляет верхний слой кожи. Это помогает улучшить текстуру кожи, уменьшить морщины, пигментацию и акне. Существуют разные типы пилингов - от поверхностных до глубоких. Выбор зависит от состояния вашей кожи и желаемого результата.",

  "Привет всем! Сегодня мы поговорим о мезотерапии. Это процедура, при которой в кожу вводятся микроинъекции с витаминами, минералами и аминокислотами. Мезотерапия помогает улучшить тонус кожи, уменьшить морщины и улучшить цвет лица. Процедура практически безболезненна и не требует восстановительного периода. Для достижения наилучших результатов рекомендуется пройти курс из нескольких процедур.",

  "Добрый день! Сегодня я расскажу о лазерной терапии для омоложения кожи. Лазерная терапия использует сфокусированный свет для удаления поврежденных клеток кожи слой за слоем. Это помогает уменьшить морщины, шрамы от акне и пигментацию. После процедуры кожа может быть красной и чувствительной, но через несколько дней она заживет и будет выглядеть более молодой и здоровой.",

  "Всем привет! В этом видео я хочу рассказать о RF-микронидлинге. Это комбинация микронидлинга и радиочастотной энергии. Микроиглы создают микроканалы в коже, а радиочастотная энергия стимулирует выработку коллагена. Эта процедура помогает уменьшить морщины, улучшить текстуру кожи и подтянуть контуры лица. Для достижения наилучших результатов рекомендуется пройти курс из 3-4 процедур.",

  "Здравствуйте, дорогие подписчики! Сегодня мы поговорим о PRP-терапии или плазмотерапии. Это процедура, при которой используется ваша собственная плазма, обогащенная тромбоцитами. Плазма вводится в кожу с помощью микроинъекций. Это помогает стимулировать выработку коллагена, улучшить тонус кожи и уменьшить морщины. PRP-терапия также может помочь при выпадении волос и для ускорения заживления после других косметических процедур.",

  "Привет всем! Сегодня я расскажу о процедуре Ultherapy. Это неинвазивная процедура, которая использует ультразвуковую энергию для стимуляции выработки коллагена в глубоких слоях кожи. Ultherapy помогает подтянуть кожу на лице, шее и декольте. Результаты становятся видны через 2-3 месяца после процедуры, когда новый коллаген начинает формироваться. Эффект может длиться до 2 лет.",

  "Добрый день! В этом видео я хочу поделиться информацией о процедуре CoolSculpting. Это неинвазивная процедура для уменьшения жировых отложений. CoolSculpting использует технологию криолиполиза, которая замораживает и уничтожает жировые клетки. Процедура безболезненна и не требует восстановительного периода. Результаты становятся видны через 1-3 месяца после процедуры, когда организм естественным образом выводит уничтоженные жировые клетки.",

  "Всем привет! Сегодня я хочу рассказать о процедуре биоревитализации. Это инъекционная процедура, при которой в кожу вводится гиалуроновая кислота. Она помогает увлажнить кожу, улучшить ее эластичность и уменьшить мелкие морщины. Биоревитализация особенно эффективна для сухой и обезвоженной кожи. После процедуры кожа становится более упругой, сияющей и молодой.",

  "Добрый день! Сегодня мы поговорим о контурной пластике. Это процедура, при которой с помощью филлеров моделируются контуры лица. Контурная пластика помогает скорректировать форму носа, подбородка, скул и губ. Процедура занимает около 30-60 минут и дает мгновенный результат. Эффект может длиться от 6 месяцев до 2 лет, в зависимости от типа используемого филлера.",

  "Привет всем! В этом видео я расскажу о процедуре HIFU-лифтинга. HIFU (High-Intensity Focused Ultrasound) - это высокоинтенсивный фокусированный ультразвук, который воздействует на глубокие слои кожи, стимулируя выработку коллагена. Эта процедура помогает подтянуть кожу, уменьшить двойной подбородок и улучшить контуры лица. Результаты становятся видны через 2-3 месяца после процедуры и могут длиться до 1-2 лет.",

  "Здравствуйте! Сегодня я хочу поделиться информацией о процедуре фракционного лазерного омоложения. Это процедура, при которой лазер создает микроскопические повреждения в коже, стимулируя процесс заживления и выработку нового коллагена. Фракционное лазерное омоложение помогает уменьшить морщины, шрамы от акне и пигментацию. После процедуры кожа становится более гладкой, упругой и молодой.",

  "Всем привет! Сегодня мы поговорим о процедуре фотоомоложения. Это неинвазивная процедура, при которой на кожу воздействуют импульсы света. Фотоомоложение помогает уменьшить пигментацию, покраснения, мелкие сосуды и улучшить текстуру кожи. Процедура безболезненна и не требует восстановительного периода. Для достижения наилучших результатов рекомендуется пройти курс из 4-6 процедур.",
];

// Функция для генерации случайной транскрипции
function generateRandomTranscription(): string {
  const randomIndex = Math.floor(Math.random() * possibleTranscriptions.length);
  return possibleTranscriptions[randomIndex];
}

// Функция для обновления транскрипции в базе данных
async function updateTranscription(
  reelId: number,
  transcript: string,
  adapter: NeonAdapter
): Promise<void> {
  try {
    console.log(`Обновление транскрипции для Reel ID: ${reelId}`);

    // Обновляем транскрипцию в базе данных
    await adapter.executeQuery(
      `UPDATE reels SET transcript = $1, updated_at = NOW() WHERE id = $2`,
      [transcript, reelId]
    );

    console.log(`Транскрипция успешно обновлена для Reel ID: ${reelId}`);
  } catch (error) {
    console.error(
      `Ошибка при обновлении транскрипции для Reel ID ${reelId}: ${error}`
    );
    throw new Error(
      `Ошибка при обновлении транскрипции: ${error instanceof Error ? error.message : String(error)}`
    );
  }
}

// Основная функция
async function main() {
  console.log(
    `Генерация демонстрационных транскрипций для рилсов проекта ${projectId} с минимум ${minViews} просмотров`
  );
  console.log(`Максимальное количество рилсов для обработки: ${limit}`);

  // Инициализируем адаптер для работы с базой данных
  const adapter = new NeonAdapter();
  await adapter.initialize();
  console.log("Соединение с БД Neon успешно инициализировано.");

  try {
    // Получаем список рилсов без транскрипций
    const reelsResult = await adapter.executeQuery(
      `SELECT r.*, h.tag_name as hashtag_name
       FROM reels r, hashtags h
       WHERE r.project_id = $1
       AND h.project_id = $1
       AND r.source_type = 'hashtag'
       AND r.views_count >= $2
       AND h.id::text = r.source_identifier
       AND r.transcript IS NULL
       ORDER BY r.views_count DESC
       LIMIT $3`,
      [projectId, minViews, limit]
    );

    if (!reelsResult || !reelsResult.rows) {
      console.log("Запрос не вернул результатов или произошла ошибка");
      return;
    }

    console.log(`Найдено ${reelsResult.rows.length} рилсов без транскрипций`);

    if (reelsResult.rows.length === 0) {
      console.log("Нет рилсов для генерации транскрипций");
      return;
    }

    // Обрабатываем каждый рил
    for (let i = 0; i < reelsResult.rows.length; i++) {
      const reel = reelsResult.rows[i];
      console.log(
        `\n======= Обработка рила ${i + 1}/${reelsResult.rows.length} =======`
      );
      console.log(
        `ID: ${reel.id}, Хэштег: #${reel.hashtag_name}, URL: ${reel.reel_url}`
      );
      console.log(
        `Автор: ${reel.author_username}, Просмотры: ${reel.views_count}`
      );

      try {
        // Генерируем случайную транскрипцию
        const transcript = generateRandomTranscription();
        console.log(
          `Сгенерирована транскрипция (${transcript.length} символов)`
        );

        // Обновляем транскрипцию в базе данных
        await updateTranscription(reel.id, transcript, adapter);

        console.log(`Успешно обработан рил ID: ${reel.id}`);

        // Пауза между обработкой рилсов
        if (i < reelsResult.rows.length - 1) {
          console.log("Пауза перед обработкой следующего рила...");
          await new Promise((resolve) => setTimeout(resolve, 100));
        }
      } catch (error) {
        console.error(`Ошибка при обработке рила ID: ${reel.id}: ${error}`);
      }
    }

    console.log("\nГенерация транскрипций завершена");
  } catch (error) {
    console.error("Ошибка при генерации транскрипций:", error);
  } finally {
    // Закрываем соединение с базой данных
    await adapter.close();
  }
}

// Запускаем основную функцию
main();
