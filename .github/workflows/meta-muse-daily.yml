name: üê≠ Meta Muse Daily Automation

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00 UTC (05:00 MSK)
    - cron: "0 2 * * *"
  workflow_dispatch:
    # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    inputs:
      force_full_cycle:
        description: "Force full cycle (ignore recent data)"
        required: false
        default: "false"
        type: boolean

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  meta-muse-daily:
    runs-on: ubuntu-latest
    timeout-minutes: 180 # 3 —á–∞—Å–∞ –º–∞–∫—Å–∏–º—É–º

    steps:
      - name: üîÑ Checkout Repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: üì¶ Install Dependencies
        run: bun install --frozen-lockfile

      - name: üîç Environment Check
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
          echo "DATABASE_URL: ${DATABASE_URL:0:20}..."
          echo "APIFY_TOKEN: ${APIFY_TOKEN:0:10}..."
          echo "OPENAI_API_KEY: ${OPENAI_API_KEY:0:10}..."
          echo "TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:0:10}..."

      - name: üèóÔ∏è Build Project
        run: bun run build

      - name: üîß Database Migration
        run: bun run db:migrate
        continue-on-error: true

      - name: üê≠ Meta Muse Daily Cycle
        id: meta_muse
        run: |
          echo "üê≠ –ó–∞–ø—É—Å–∫ Meta Muse Daily Automation..."

          # –°–æ–∑–¥–∞–µ–º –ª–æ–≥ —Ñ–∞–π–ª
          LOG_FILE="meta-muse-daily-$(date +%Y%m%d_%H%M%S).log"

          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          bun run meta-muse:daily 2>&1 | tee "$LOG_FILE"

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT

          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          echo "üìä –ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
          grep -E "(‚úÖ|‚ùå|üìä|üéØ)" "$LOG_FILE" | tail -10 || echo "–ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"

          exit $EXIT_CODE

      - name: üìä Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: meta-muse-logs-${{ github.run_number }}
          path: meta-muse-daily-*.log
          retention-days: 7

      - name: üì± Telegram Success Notification
        if: success()
        run: |
          STATS=$(grep -E "(üìä|üéØ|‚úÖ)" meta-muse-daily-*.log | tail -5 | tr '\n' ' ' || echo "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")

          MESSAGE="üéâ *Meta Muse Daily - –£–°–ü–ï–•*

          üìÖ –î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M UTC')
          ü§ñ GitHub Action: –ó–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ

          üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:*
          $STATS

          üîó [–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          üê≠ Meta Muse –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç!"

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: üì± Telegram Error Notification
        if: failure()
        run: |
          ERROR_LOG=$(grep -E "(‚ùå|üí•|ERROR)" meta-muse-daily-*.log | tail -3 | tr '\n' ' ' || echo "–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")

          MESSAGE="üö® *Meta Muse Daily - –û–®–ò–ë–ö–ê*

          üìÖ –î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M UTC')
          ü§ñ GitHub Action: –ó–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–æ–π

          ‚ùå *–û—à–∏–±–∫–∏:*
          $ERROR_LOG

          üîó [–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          üîß –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: üßπ Cleanup
        if: always()
        run: |
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          # –£–¥–∞–ª—è–µ–º –±–æ–ª—å—à–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å
          find . -name "*.tmp" -size +10M -delete 2>/dev/null || true
          echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
