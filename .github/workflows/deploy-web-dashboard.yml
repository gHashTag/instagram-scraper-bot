name: ðŸŒ Deploy Web Dashboard

on:
  push:
    branches: [ main ]
    paths: 
      - 'vaults/coco-age/**'
      - 'scripts/create-web-dashboard.ts'
  
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ vault
  workflow_run:
    workflows: ["ðŸ”„ Update Obsidian Vault Daily"]
    types:
      - completed
  
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŒ Generate web dashboard
        run: |
          echo "ðŸŒ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð²ÐµÐ±-Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð°..."
          npm run web:dashboard

      - name: ðŸ“‹ Prepare deployment
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ GitHub Pages
          mkdir -p ./public
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          if [ -d "./docs/web-dashboard" ]; then
            cp -r ./docs/web-dashboard/* ./public/
            echo "âœ… Ð¤Ð°Ð¹Ð»Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð² public/"
          else
            echo "âŒ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ web-dashboard Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
            exit 1
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .nojekyll Ð´Ð»Ñ GitHub Pages
          touch ./public/.nojekyll
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ CNAME ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶ÐµÐ½ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¹ Ð´Ð¾Ð¼ÐµÐ½
          # echo "dashboard.cocoage.com" > ./public/CNAME

      - name: ðŸ“Š Generate deployment info
        run: |
          cat > ./public/deployment-info.json << EOF
          {
            "deployedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "deployedAtFormatted": "$(date -u +"%Y-%m-%d %H:%M:%S UTC")",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow": "${{ github.workflow }}",
            "actor": "${{ github.actor }}"
          }
          EOF

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: true
          commit_message: |
            ðŸŒ Deploy web dashboard - ${{ github.event.head_commit.message }}
            
            ðŸ“… Deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            ðŸ”— Commit: ${{ github.sha }}
            ðŸ‘¤ Actor: ${{ github.actor }}

      - name: ðŸ“ˆ Generate deployment summary
        run: |
          echo "## ðŸŒ Web Dashboard Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚" >> $GITHUB_STEP_SUMMARY
          echo "**Ð’Ñ€ÐµÐ¼Ñ:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ¸:" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“Š Ð’ÐµÐ±-Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“ GitHub Pages](https://github.com/${{ github.repository }}/settings/pages)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¥¥âœ¨ Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð° Coco Age" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ÑŒ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘¥ ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ñ…ÑÑˆÑ‚ÐµÐ³Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ­ ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚-Ð·Ð°Ð²Ð¾Ð´" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Notify on failure
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ð’ÐµÐ±-Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð´Ð»Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸." >> $GITHUB_STEP_SUMMARY
