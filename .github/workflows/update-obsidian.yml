name: üîÑ Update Obsidian Vault Daily

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 UTC (9:00 –ú–°–ö)
    - cron: '0 6 * * *'
  
  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID to sync (default: 1 for Coco Age)'
        required: false
        default: '1'

jobs:
  update-vault:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîß Setup environment
        run: |
          echo "OBSIDIAN_VAULT_PATH=${{ github.workspace }}/vaults/coco-age" >> $GITHUB_ENV
          echo "NODE_ENV=production" >> $GITHUB_ENV

      - name: üóÑÔ∏è Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üóÑÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
          npm run db:migrate

      - name: üîÑ Update Obsidian vault data
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OBSIDIAN_VAULT_PATH: ${{ github.workspace }}/vaults/coco-age
        run: |
          echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Obsidian vault –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ ${{ github.event.inputs.project_id || '1' }}..."
          npm run sync-obsidian ${{ github.event.inputs.project_id || '1' }}

      - name: üìä Check for changes
        id: changes
        run: |
          if git diff --quiet HEAD -- vaults/coco-age/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ vault"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ vault"
            git diff --stat HEAD -- vaults/coco-age/
          fi

      - name: üíæ Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è push
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

          # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã vault
          git add vaults/coco-age/

          # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç —Å –¥–∞—Ç–æ–π
          COMMIT_DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          git commit -m "üîÑ Auto-update Obsidian vault - $COMMIT_DATE

          üìä –û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:
          - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
          - –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
          - –ú–µ—Ç—Ä–∏–∫–∏ —Ö—ç—à—Ç–µ–≥–æ–≤
          - –¢–æ–ø-–∫–æ–Ω—Ç–µ–Ω—Ç —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è–º–∏

          ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ GitHub Actions"

          # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push

      - name: üì± Send Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: "144022504"
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            STATUS="‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"
            EMOJI="üîÑ"
            MESSAGE_TYPE="success"
          else
            STATUS="‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
            EMOJI="üìä"
            MESSAGE_TYPE="no_changes"
          fi

          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ñ–∞–π–ª–æ–≤
          TOTAL_FILES=$(find vaults/coco-age -name "*.md" | wc -l)
          VAULT_SIZE=$(du -sh vaults/coco-age | cut -f1)

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="$EMOJI *Coco Age Vault Update*

          üìÖ *–î–∞—Ç–∞:* $(date '+%d.%m.%Y %H:%M') UTC
          üéØ *–ü—Ä–æ–µ–∫—Ç:* Coco Age (ID: ${{ github.event.inputs.project_id || '1' }})
          üìä *–°—Ç–∞—Ç—É—Å:* $STATUS

          üìÅ *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ vault:*
          ‚Ä¢ –§–∞–π–ª–æ–≤: $TOTAL_FILES
          ‚Ä¢ –†–∞–∑–º–µ—Ä: $VAULT_SIZE

          üîó *–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏:*
          ‚Ä¢ [–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞](https://github.com/gHashTag/instagram-scraper/blob/main/vaults/coco-age/ü••‚ú®%20Coco%20Age%20-%20–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è%20–∫–∞—Ä—Ç–∞.md)
          ‚Ä¢ [–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ](https://github.com/gHashTag/instagram-scraper/blob/main/vaults/coco-age/üìä%20–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ%20–∫–æ–Ω—Ç–µ–Ω—Ç–∞.md)
          ‚Ä¢ [–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã](https://github.com/gHashTag/instagram-scraper/blob/main/vaults/coco-age/üë•%20–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.md)

          ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ GitHub Actions"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
          if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TELEGRAM_CHAT_ID" \
              -d "text=$MESSAGE" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
            echo "üì± Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
          else
            echo "‚ö†Ô∏è TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          fi

      - name: üìà Generate summary
        if: always()
        run: |
          echo "## ü••‚ú® Obsidian Vault Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**–ü—Ä–æ–µ–∫—Ç:** Coco Age (ID: ${{ github.event.inputs.project_id || '1' }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ **–°—Ç–∞—Ç—É—Å:** Vault —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìä –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git diff --name-only HEAD~1 HEAD -- vaults/coco-age/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **–°—Ç–∞—Ç—É—Å:** –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏:" >> $GITHUB_STEP_SUMMARY
          echo "- [üìä –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞](./vaults/coco-age/ü••‚ú®%20Coco%20Age%20-%20–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è%20–∫–∞—Ä—Ç–∞.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [üìÖ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞](./vaults/coco-age/üìä%20–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ%20–∫–æ–Ω—Ç–µ–Ω—Ç–∞.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [üë• –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã](./vaults/coco-age/üë•%20–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [üè∑Ô∏è –•—ç—à—Ç–µ–≥–∏](./vaults/coco-age/üè∑Ô∏è%20–•—ç—à—Ç–µ–≥–∏.md)" >> $GITHUB_STEP_SUMMARY

      - name: üö® Notify on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: "144022504"
        run: |
          echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ Obsidian vault" >> $GITHUB_STEP_SUMMARY
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã." >> $GITHUB_STEP_SUMMARY

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ Telegram
          ERROR_MESSAGE="üö® *–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Coco Age Vault*

          üìÖ *–î–∞—Ç–∞:* $(date '+%d.%m.%Y %H:%M') UTC
          ‚ùå *–°—Ç–∞—Ç—É—Å:* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
          üéØ *–ü—Ä–æ–µ–∫—Ç:* Coco Age

          üîç *–î–µ–π—Å—Ç–≤–∏—è:*
          ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ GitHub Actions
          ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

          üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏](https://github.com/gHashTag/instagram-scraper/actions)

          ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ"

          if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TELEGRAM_CHAT_ID" \
              -d "text=$ERROR_MESSAGE" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
            echo "üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
          fi
