name: ğŸ¯ Update Client Dashboard

on:
  schedule:
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 24 Ñ‡Ğ°ÑĞ° Ğ² 9:00 UTC (12:00 MSK)
    - cron: "0 9 * * *"
  workflow_dispatch: # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
    inputs:
      force_update:
        description: "Force update dashboard"
        required: false
        default: "false"

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    name: ğŸ“Š Update Dashboard Data

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ” Check API Health
        run: |
          echo "ğŸ” Checking API health..."
          curl -f https://instagram-scraper-bot.vercel.app/health || exit 1
          echo "âœ… API is healthy"

      - name: ğŸ“Š Fetch Fresh Data
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
        run: |
          echo "ğŸ“Š Fetching fresh data from API..."

          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ¾Ğ²
          curl -s "https://instagram-scraper-bot.vercel.app/api/competitors" > /tmp/competitors.json

          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ…ÑÑˆÑ‚ĞµĞ³Ğ¾Ğ²
          curl -s "https://instagram-scraper-bot.vercel.app/api/hashtags" > /tmp/hashtags.json

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ñ‹
          if [ -s /tmp/competitors.json ] && [ -s /tmp/hashtags.json ]; then
            echo "âœ… Data fetched successfully"
            echo "COMPETITORS_COUNT=$(jq '.total' /tmp/competitors.json)" >> $GITHUB_ENV
            echo "HASHTAGS_COUNT=$(jq '.total' /tmp/hashtags.json)" >> $GITHUB_ENV
          else
            echo "âŒ Failed to fetch data"
            exit 1
          fi

      - name: ğŸš€ Trigger Dashboard Update
        run: |
          echo "ğŸš€ Triggering dashboard update..."

          # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ webhook Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°
          curl -X POST "https://instagram-scraper-bot.vercel.app/api/dashboard-data" \
            -H "Content-Type: application/json" \
            -d '{
              "action": "update",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
              "source": "github-actions",
              "competitors_count": '$COMPETITORS_COUNT',
              "hashtags_count": '$HASHTAGS_COUNT'
            }'

      - name: ğŸ“± Send Telegram Notification
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            echo "ğŸ“± Sending Telegram notification..."
            
            MESSAGE="ğŸ¯ *Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½*%0A%0A"
            MESSAGE="${MESSAGE}ğŸ“Š ĞšĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ñ‹: ${COMPETITORS_COUNT}%0A"
            MESSAGE="${MESSAGE}ğŸ·ï¸ Ğ¥ÑÑˆÑ‚ĞµĞ³Ğ¸: ${HASHTAGS_COUNT}%0A"
            MESSAGE="${MESSAGE}ğŸ• Ğ’Ñ€ĞµĞ¼Ñ: $(date +'%Y-%m-%d %H:%M:%S UTC')%0A%0A"
            MESSAGE="${MESSAGE}ğŸ”— [ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´](https://instagram-scraper-bot.vercel.app/dashboard)"
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
            
            echo "âœ… Telegram notification sent"
          else
            echo "âš ï¸ Telegram credentials not configured"
          fi

      - name: ğŸ“ Update README
        run: |
          echo "ğŸ“ Updating README with dashboard info..."

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞµĞºÑ†Ğ¸Ñ Ğ² README
          cat >> README.md << EOF

          ## ğŸ¯ Client Dashboard

          **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          - ğŸ“Š **Dashboard URL:** https://instagram-scraper-bot.vercel.app/dashboard
          - ğŸ¢ **Competitors:** ${COMPETITORS_COUNT}
          - ğŸ·ï¸ **Hashtags:** ${HASHTAGS_COUNT}
          - ğŸ”„ **Auto-update:** Every 24 hours

          ### Quick Links:
          - [ğŸ“Š Client Dashboard](https://instagram-scraper-bot.vercel.app/dashboard)
          - [ğŸ”§ API Health](https://instagram-scraper-bot.vercel.app/health)
          - [ğŸ“‹ API Documentation](https://instagram-scraper-bot.vercel.app/api)

          EOF

      - name: ğŸ“Š Generate Dashboard Report
        run: |
          echo "ğŸ“Š Generating dashboard report..."

          cat > dashboard-report.md << EOF
          # ğŸ¯ Dashboard Update Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Status:** âœ… Success

          ## ğŸ“Š Data Summary

          - **Competitors:** ${COMPETITORS_COUNT}
          - **Hashtags:** ${HASHTAGS_COUNT}
          - **Dashboard URL:** https://instagram-scraper-bot.vercel.app/dashboard

          ## ğŸ”„ Next Update

          The dashboard will automatically update in 24 hours.

          ## ğŸ“± Access Links

          - [ğŸ“Š Client Dashboard](https://instagram-scraper-bot.vercel.app/dashboard)
          - [ğŸ”§ API Health Check](https://instagram-scraper-bot.vercel.app/health)
          - [ğŸ“‹ API Documentation](https://instagram-scraper-bot.vercel.app/api)

          ---

          *Generated by GitHub Actions*
          EOF

          echo "âœ… Dashboard report generated"

      - name: ğŸ‰ Success Summary
        run: |
          echo "ğŸ‰ Dashboard update completed successfully!"
          echo ""
          echo "ğŸ“Š Summary:"
          echo "  - Competitors: ${COMPETITORS_COUNT}"
          echo "  - Hashtags: ${HASHTAGS_COUNT}"
          echo "  - Dashboard: https://instagram-scraper-bot.vercel.app/dashboard"
          echo "  - Next update: $(date -d '+24 hours' -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âœ… All tasks completed successfully!"

  # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°
  verify-dashboard:
    needs: update-dashboard
    runs-on: ubuntu-latest
    name: âœ… Verify Dashboard

    steps:
      - name: ğŸ” Test Dashboard Accessibility
        run: |
          echo "ğŸ” Testing dashboard accessibility..."

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
          if curl -f -s "https://instagram-scraper-bot.vercel.app/dashboard" > /dev/null; then
            echo "âœ… Dashboard is accessible"
          else
            echo "âŒ Dashboard is not accessible"
            exit 1
          fi

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ API Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°
          if curl -f -s "https://instagram-scraper-bot.vercel.app/api/dashboard-data" > /dev/null; then
            echo "âœ… Dashboard API is working"
          else
            echo "âŒ Dashboard API is not working"
            exit 1
          fi

      - name: ğŸ“Š Dashboard Health Check
        run: |
          echo "ğŸ“Š Performing dashboard health check..."

          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°
          DASHBOARD_DATA=$(curl -s "https://instagram-scraper-bot.vercel.app/api/dashboard-data")

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
          if echo "$DASHBOARD_DATA" | jq -e '.overview.totalCompetitors' > /dev/null; then
            echo "âœ… Dashboard data structure is valid"
            
            TOTAL_COMPETITORS=$(echo "$DASHBOARD_DATA" | jq -r '.overview.totalCompetitors')
            TOTAL_HASHTAGS=$(echo "$DASHBOARD_DATA" | jq -r '.overview.totalHashtags')
            TOTAL_REELS=$(echo "$DASHBOARD_DATA" | jq -r '.overview.totalReels')
            
            echo "ğŸ“Š Dashboard metrics:"
            echo "  - Competitors: $TOTAL_COMPETITORS"
            echo "  - Hashtags: $TOTAL_HASHTAGS"
            echo "  - Reels: $TOTAL_REELS"
          else
            echo "âŒ Dashboard data structure is invalid"
            exit 1
          fi

      - name: ğŸ¯ Final Verification
        run: |
          echo "ğŸ¯ Final verification completed!"
          echo ""
          echo "âœ… Dashboard is fully operational"
          echo "ğŸ”— Access: https://instagram-scraper-bot.vercel.app/dashboard"
          echo "ğŸ“± Mobile-friendly: Yes"
          echo "ğŸ”„ Auto-refresh: 24 hours"
          echo ""
          echo "ğŸ‰ Client dashboard is ready for use!"
